---
- name: 显示当前主机的系统信息
  ansible.builtin.debug:
    msg:
      - "操作系统: {{ ansible_distribution }}"
      - "版本: {{ ansible_distribution_version }}"
      - "CPU架构: {{ ansible_architecture }}"

- name: 检查Kubernetes集群
  kubernetes.core.k8s_info:
    kind: Node
    api_version: v1
  register: k8s_nodes
  failed_when: false
  run_once: true

- name: 验证Kubernetes集群可用性
  ansible.builtin.assert:
    that:
      - k8s_nodes.resources is defined
      - k8s_nodes.resources | length > 0
    success_msg: "Kubernetes集群已部署，发现{{ k8s_nodes.resources | length }}个节点"
    fail_msg: "未检测到可用的Kubernetes集群，请先部署集群"
  run_once: true


- name: "计算可用节点数量（排除不可调度节点）"
  set_fact:
    available_nodes: "{{ (k8s_nodes.resources | rejectattr('spec.unschedulable', 'defined') | list | length) | int }}"
  run_once: true

- name: "转换参数为整数"
  set_fact:
    app_nodes: "{{ available_nodes | int }}"
  run_once: true


- name: "显示最终配置"
  ansible.builtin.debug:
    msg:
      - "集群总节点数: {{ k8s_nodes.resources | length }}"
      - "可用节点数（排除封锁节点）: {{ app_nodes }}"
  run_once: true


# 自动判断部署模式
- name: 单点模式配置（1个可用节点）
  ansible.builtin.set_fact:
    app_mode: "standalone"
    deployment_kind: "Deployment"
    headless_needed: false
    app_replicas: 1
  when: app_nodes | int == 1

- name: 集群模式配置（≥2个可用节点）
  ansible.builtin.set_fact:
    app_mode: "cluster"
    deployment_kind: "StatefulSet"
    headless_needed: true
    app_replicas: "{{ app_nodes | int }}"  # 节点数=副本数
  when: app_nodes | int > 1

- name: 校验 NodePort 端口范围
  ansible.builtin.assert:
    that:
      - app_nodeport | int >= 30000
      - app_nodeport | int <= 32767

